zmodload zsh/datetime
start=$EPOCHREALTIME

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi


#
# Exports
#

export HISTFILE=~/.histfile
export HISTSIZE=1000
export SAVEHIST=1000
export EDITOR=micro
export GIT_EDITOR=micro
export RUSTC_WRAPPER=sccache
export ZSH_AUTOSUGGEST_USE_ASYNC=1
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)
export RBENV_SHELL=zsh

{% if yadm.os == "Linux" %}
export WINEESYNC=1
export WINEFSYNC=1
export PAGER='moar'
export SYSTEMD_LESS='FRSMK'
export SYSTEMD_PAGER='moar'
{% endif %}


#
# Path
#

path+=('$HOME/.local/bin')

{% if yadm.os == "Linux" %}
path+=('/usr/lib/ccache/bin/')
{% endif %}

{% if yadm.os == "Darwin" %}
path+=('/usr/local/bin/ccache' '/usr/local/opt/python/libexec/bin')
{% endif %}

#
# Options
#

bindkey -e
setopt sharehistory autocd extendedglob append_history hist_ignore_dups hist_expire_dups_first hist_verify hist_ignore_space

# The following lines were added by compinstall
zstyle ':completion:*' completer _expand _complete _ignored _correct _approximate
zstyle ':completion:*' matcher-list '' 'm:{[:lower:]}={[:upper:]} m:{[:lower:][:upper:]}={[:upper:][:lower:]}' 'l:|=* r:|=*'
zstyle ':completion::complete:*' gain-privileges 1
zstyle ':completion:*' menu select
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1 --color=always $realpath'

autoload -Uz compinit
compinit

autoload edit-command-line
zle -N edit-command-line

exit_zsh() { exit }
zle -N exit_zsh

zle -N history-substring-search-up
zle -N history-substring-search-down


#
# Sources
#

{% if yadm.os == "Linux" %}
source '/usr/lib/rbenv/completions/rbenv.zsh'
{% endif %}

{% if yadm.os == "Darwin" %}
fpath+=("$(brew --prefix)/share/zsh/site-functions")
{% endif %}

source "$HOME/.config/zsh/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"
source "$HOME/.config/zsh/zsh-autosuggestions/zsh-autosuggestions.zsh"
source "$HOME/.config/zsh/fzf-tab/fzf-tab.plugin.zsh"
source "$HOME/.config/zsh/zsh-history-substring-search/zsh-history-substring-search.zsh"
source "$HOME/.config/zsh/powerlevel10k/powerlevel10k.zsh-theme"


#
# Aliases
#

alias ls='exa'
alias nano='micro'
alias cat=bat

{% if yadm.os == "Linux" %}
alias cp='cp --reflink=auto'
alias tkg="bash $HOME/git/tkg/update.sh"
alias copy="xclip -selection c"
alias yay=paru
{% endif %}


#
# Functions
#

function mkcd(){
	mkdir -p -- "$1" &&
	cd -P -- "$1"
}

function paste() {
	curl --progress-bar -F "file=@${1:--}" https://0x0.st | tee
}


#
# Bindings
#

bindkey '^X^e' edit-command-line
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey '^D' exit_zsh


#
# rbenv
#

eval "$(rbenv init - zsh)"

{% if yadm.os == "Linux" %}
#
# Terminal title hooks
#

autoload -Uz add-zsh-hook

zshcache_time="$(date +%s%N)"
TRAPUSR1() {
  rehash
}

function xterm_title_precmd () {
	print -Pn -- '\e]2;%n@%m %~\a'
	[[ "$TERM" == 'screen'* ]] && print -Pn -- '\e_\005{g}%n\005{-}@\005{m}%m\005{-} \005{B}%~\005{-}\e\\'
}

function xterm_title_preexec () {
	print -Pn -- '\e]2;%n@%m %~ %# ' && print -n -- "${(q)1}\a"
	[[ "$TERM" == 'screen'* ]] && { print -Pn -- '\e_\005{g}%n\005{-}@\005{m}%m\005{-} \005{B}%~\005{-} %# ' && print -n -- "${(q)1}\e\\"; }
}

if [[ "$TERM" == (alacritty*|gnome*|konsole*|putty*|rxvt*|screen*|tmux*|xterm*) ]]; then
	add-zsh-hook -Uz precmd xterm_title_precmd
	add-zsh-hook -Uz preexec xterm_title_preexec
fi
{% endif %}


[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

dur=$(echo "$EPOCHREALTIME - $start" | bc)
echo "Execution time: $dur seconds"
